// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= TENANT (Multi-tenancy) =============
model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  banner    String?
  email     String   @unique
  phone     String?
  whatsapp  String?
  address   String?
  district  String?  // Bairro
  city      String?
  state     String?
  zipCode   String?
  country   String?
  website   String?
  
  // Landing page
  about           String?
  description     String?
  latitude        Float?
  longitude       Float?
  
  // Redes Sociais
  instagram       String?
  facebook        String?
  twitter         String?
  
  // Formas de Pagamento (JSON array)
  paymentMethods  String? // JSON: ["PIX", "Cartão de Crédito", ...]
  
  // Comodidades (JSON array)
  amenities       String? // JSON: ["WiFi", "Estacionamento", ...]
  
  // Configuração de blocos da landing page (JSON array)
  landingBlocks   String? // JSON: [{id, name, label, enabled, order}, ...]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  clients         Client[]
  professionals   Professional[]
  services        Service[]
  categories      Category[]
  products        Product[]
  suppliers       Supplier[]
  packages        Package[]
  appointments    Appointment[]
  transactions    Transaction[]
  commissions     Commission[]
  cashRegisters   CashRegister[]
  businessHours   BusinessHours[]
  configs         Configuration?
  subscription    Subscription?
  bookingPolicy   BookingPolicy?
  evolutionMapping TenantEvolutionMapping?

  @@index([slug])

}

// ============= USUARIOS =============
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(PROFESSIONAL)
  avatar    String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // MASTER não tem tenant (acessa todos)
  // OWNER e PROFESSIONAL pertencem a um tenant
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Se for PROFESSIONAL, vincula ao registro de Professional
  professionalId String?   @unique
  professional   Professional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([email])
}

enum UserRole {
  MASTER        // Você - Dono do SaaS (acessa TUDO)
  OWNER         // Dono do salão (acessa só o tenant dele)
  PROFESSIONAL  // Funcionário/Barbeiro (acessa só os dados dele)
}

// ============= CLIENTES =============
model Client {
  id          String    @id @default(cuid())
  name        String
  email       String?
  phone       String?
  cpf         String?
  birthDate   DateTime?
  gender      String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  notes       String?
  active      Boolean   @default(true)
  notifications Boolean @default(true)
  blocked     Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  appointments    Appointment[]
  transactions    Transaction[]
  clientPackages  ClientPackage[]

  @@index([tenantId])
  @@index([email])
  @@index([phone])
  @@index([tenantId, name]) // Índice composto para buscas otimizadas
}

// ============= PROFISSIONAIS =============
model Professional {
  id          String   @id @default(cuid())
  name        String  // Nome completo (mantido para compatibilidade)
  firstName   String?
  lastName    String?
  email       String?
  phone       String?
  cpf         String?
  rg          String?
  birthDate   DateTime?
  profession  String?
  specialty   String?
  bio         String?
  avatar      String?
  color       String?
  
  // Endereço
  address           String?
  addressNumber     String?
  addressComplement String?
  neighborhood      String?
  city              String?
  state             String?
  zipCode           String?
  
  // Assinatura digital
  signature   String?
  
  // Configurações
  isActive            Boolean @default(true)
  availableOnline     Boolean @default(true)
  generateSchedule    Boolean @default(true)
  receivesCommission  Boolean @default(true)
  partnershipContract Boolean @default(false)
  
  // Financeiro
  commission     Float   @default(0)  // Mantido para compatibilidade
  commissionRate Decimal @default(0) @db.Decimal(5, 2)
  
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Usuário vinculado (para login do profissional)
  user         User?
  
  appointments Appointment[]
  commissions  Commission[]
  services     ProfessionalService[]
  schedules    ProfessionalSchedule[]
  availabilityRules AvailabilityRule[]

  @@index([tenantId])
  @@index([tenantId, name]) // Índice composto para buscas otimizadas
}

model ProfessionalService {
  id             String @id @default(cuid())
  professionalId String
  serviceId      String

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([professionalId, serviceId])
}

model ProfessionalSchedule {
  id             String  @id @default(cuid())
  professionalId String
  dayOfWeek      Int
  startTime      String
  endTime        String
  isActive       Boolean @default(true)

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
}

// ============= SERVICOS =============
model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  duration    Int
  price       Float
  color       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  appointments    Appointment[]
  professionals   ProfessionalService[]
  packageServices PackageService[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([tenantId, name]) // Índice composto para buscas otimizadas
}

// ============= CATEGORIAS =============
model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  services Service[]
  products Product[]

  @@index([tenantId])
  @@index([tenantId, name]) // Índice composto para buscas otimizadas
}

// ============= PRODUTOS =============
model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  sku         String?
  barcode     String?
  price       Float
  cost        Float?
  stock       Int      @default(0)
  minStock    Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  transactionItems TransactionItem[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([sku])
}

// ============= FORNECEDORES =============
model Supplier {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  cnpj        String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  contactName String?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, name]) // Índice composto para buscas otimizadas
}

// ============= PACOTES =============
model Package {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  validDays   Int      @default(30)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  services       PackageService[]
  clientPackages ClientPackage[]

  @@index([tenantId])
}

model PackageService {
  id        String @id @default(cuid())
  packageId String
  serviceId String
  quantity  Int    @default(1)

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([packageId, serviceId])
}

model ClientPackage {
  id             String        @id @default(cuid())
  clientId       String
  packageId      String
  purchaseDate   DateTime      @default(now())
  expirationDate DateTime
  usedQuantity   Int           @default(0)
  totalQuantity  Int
  status         PackageStatus @default(ACTIVE)

  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([packageId])
}

enum PackageStatus {
  ACTIVE
  EXPIRED
  USED
  CANCELLED
}

// ============= AGENDAMENTOS =============
model Appointment {
  id        String            @id @default(cuid())
  date      DateTime
  startTime String
  endTime   String
  status    AppointmentStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  clientId       String?  // Opcional para agendamentos públicos
  professionalId String?
  serviceId      String
  tenantId       String

  // Dados do cliente (para agendamentos públicos)
  customerName    String?
  customerPhone   String?
  customerEmail   String?

  // Reagendamento
  originalAppointmentId String?
  rescheduledFrom       Appointment?  @relation("AppointmentReschedules", fields: [originalAppointmentId], references: [id])
  rescheduledTo         Appointment[] @relation("AppointmentReschedules")

  // Cancelamento
  cancelledAt       DateTime?
  cancellationReason String?

  // Confirmação
  confirmedAt       DateTime?
  confirmationToken String? @unique

  // Avaliação
  rating            Int? // 1-5
  review            String?

  client       Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  professional Professional? @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  transaction Transaction?

  @@index([tenantId])
  @@index([clientId])
  @@index([professionalId])
  @@index([date])
  @@index([confirmationToken])
  @@index([originalAppointmentId])
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============= TRANSACOES FINANCEIRAS =============
model Transaction {
  id            String            @id @default(cuid())
  type          TransactionType
  amount        Float
  description   String?
  paymentMethod PaymentMethod?
  status        TransactionStatus @default(PENDING)
  dueDate       DateTime?
  paidAt        DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  clientId       String?
  appointmentId  String?        @unique
  tenantId       String
  cashRegisterId String?

  client       Client?       @relation(fields: [clientId], references: [id])
  appointment  Appointment?  @relation(fields: [appointmentId], references: [id])
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashRegister CashRegister? @relation(fields: [cashRegisterId], references: [id])

  items TransactionItem[]

  @@index([tenantId])
  @@index([clientId])
  @@index([type])
  @@index([status])
}

model TransactionItem {
  id            String @id @default(cuid())
  transactionId String
  productId     String?
  description   String
  quantity      Int    @default(1)
  unitPrice     Float
  total         Float

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product?    @relation(fields: [productId], references: [id])

  @@index([transactionId])
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
  BOLETO
  OTHER
}

// ============= CAIXA =============
model CashRegister {
  id             String     @id @default(cuid())
  openedAt       DateTime   @default(now())
  closedAt       DateTime?
  openingBalance Float
  closingBalance Float?
  status         CashStatus @default(OPEN)
  notes          String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  transactions Transaction[]

  @@index([tenantId])
  @@index([status])
}

enum CashStatus {
  OPEN
  CLOSED
}

// ============= COMISSOES =============
model Commission {
  id             String           @id @default(cuid())
  professionalId String
  amount         Float
  percentage     Float
  referenceMonth String
  status         CommissionStatus @default(PENDING)
  paidAt         DateTime?
  createdAt      DateTime         @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([professionalId])
  @@index([referenceMonth])
}

enum CommissionStatus {
  PENDING
  PAID
  CANCELLED
}

// ============= CONFIGURACOES =============
model Configuration {
  id       String @id @default(cuid())
  tenantId String @unique

  businessName    String?
  businessEmail   String?
  businessPhone   String?
  businessAddress String?
  timezone        String  @default("America/Sao_Paulo")
  currency        String  @default("BRL")
  dateFormat      String  @default("DD/MM/YYYY")
  timeFormat      String  @default("HH:mm")

  slotDuration     Int     @default(30)
  advanceBooking   Int     @default(30)
  cancellationTime Int     @default(24)

  workStartTime String @default("08:00")
  workEndTime   String @default("18:00")
  workDays      String @default("1,2,3,4,5")

  emailNotifications    Boolean @default(true)
  smsNotifications      Boolean @default(false)
  whatsappNotifications Boolean @default(false)

  // ========== BRANDING E CORES ==========
  themeTemplate         String  @default("light") // light, dark, custom
  backgroundColor       String  @default("#FFFFFF") // Cor de fundo
  textColor            String  @default("#000000") // Cor do texto
  buttonColorPrimary   String  @default("#505afb") // Cor do botão principal
  buttonTextColor      String  @default("#FFFFFF") // Cor do texto do botão
  heroImage            String? // URL da imagem hero/capa
  
  // Conteúdo do site público (JSON com seções reordenáveis)
  sectionsConfig       String? // JSON com configuração de seções visíveis e ordem

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============= ASSINATURA =============
model Subscription {
  id        String             @id @default(cuid())
  tenantId  String             @unique
  plan      SubscriptionPlan   @default(FREE)
  status    SubscriptionStatus @default(ACTIVE)
  startDate DateTime           @default(now())
  endDate   DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
}

// ============= POLÍTICAS DE AGENDAMENTO =============
model BookingPolicy {
  id        String   @id @default(cuid())
  tenantId  String   @unique

  // Cancelamento
  allowCancellation       Boolean @default(true)
  minCancellationHours    Int     @default(24)
  maxCancellationsPerMonth Int     @default(3)

  // Reagendamento
  allowRescheduling       Boolean @default(true)
  minReschedulingHours    Int     @default(24)
  maxReschedulings        Int     @default(2)

  // Geral
  minAdvanceBookingHours  Int     @default(1)
  maxAdvanceBookingDays   Int     @default(90)
  slotDurationMinutes     Int     @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

// ============= REGRAS DE DISPONIBILIDADE =============
model AvailabilityRule {
  id             String  @id @default(cuid())
  professionalId String
  dayOfWeek      Int     // 0-6 (domingo-sábado)
  startTime      String  // "09:00"
  endTime        String  // "18:00"
  isActive       Boolean @default(true)

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, dayOfWeek])
  @@index([professionalId])
}

// ============= HORÁRIOS DE FUNCIONAMENTO =============
model BusinessHours {
  id        String  @id @default(cuid())
  tenantId  String
  dayOfWeek Int     // 0 = Segunda, 1 = Terça, ..., 6 = Domingo
  isClosed  Boolean @default(false)
  openTime  String? // "08:00"
  closeTime String? // "17:00"
  interval  String? // "12:00-14:00" (Intervalo)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
}

// ============= EVOLUTION API (WhatsApp Integration) =============
/**
 * Armazena informações sobre as instâncias da Evolution API
 * Cada instância pode suportar até 100 tenants
 * Total de 10 instâncias para até 1000 tenants
 */
model EvolutionInstance {
  id Int @id @default(autoincrement())
  
  // Nome amigável (evolution-1, evolution-2, etc)
  name String @unique
  
  // URL base da instância (http://evolution-1:8001)
  url String
  
  // Quantidade máxima de conexões simultâneas
  maxConnections Int @default(100)
  
  // Quantidade atual de tenants conectados
  tenantCount Int @default(0)
  
  // Status da instância
  isActive Boolean @default(true)
  
  // Relacionamento com mapeamentos
  tenantMappings TenantEvolutionMapping[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([isActive])
  @@index([tenantCount])
}

/**
 * Mapeia tenants para suas instâncias da Evolution API
 * Cada tenant pode ter apenas uma conexão WhatsApp
 * Uma instância Evolution pode servir até 100 tenants
 */
model TenantEvolutionMapping {
  tenantId String @id
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // ID da instância Evolution alocada
  evolutionInstanceId Int
  evolutionInstance EvolutionInstance @relation(fields: [evolutionInstanceId], references: [id], onDelete: Restrict)
  
  // Número de WhatsApp conectado
  whatsappPhoneNumber String?
  
  // Status da conexão
  isConnected Boolean @default(false)
  connectedAt DateTime?
  disconnectedAt DateTime?
  
  // Timestamp da última tentativa de gerar QR Code
  lastQRCodeGeneratedAt DateTime?
  
  // Contador de tentativas de reconexão
  reconnectAttempts Int @default(0)
  
  // Última tentativa de reconexão
  lastReconnectAttempt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([evolutionInstanceId])
  @@index([whatsappPhoneNumber])
  @@index([isConnected])
  @@index([createdAt])
}
